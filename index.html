<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oscars — Nominations (2000–2025)</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #0b1220;
      --muted: #9aa7c7;
      --accent: #facc15;
    }
    body {
      font-family: Inter, ui-sans-serif, system-ui;
      background: var(--bg);
      color: white;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 16px;
      padding: 20px;
    }
    aside {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      overflow-y: auto;
      max-height: 80vh;
    }
    .year-item {
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--muted);
    }
    .year-item:hover {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .year-item.active {
      background: var(--accent);
      color: black;
      font-weight: bold;
    }
    section {
      background: var(--card);
      padding: 16px;
      border-radius: 12px;
      overflow-y: auto;
      max-height: 80vh;
    }
    h2 {
      color: var(--accent);
      font-size: 18px;
    }
    .nominee {
      margin-left: 10px;
      font-size: 14px;
    }
    .winner {
      font-weight: bold;
      color: #fbbf24;
    }
    .status {
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Oscars — Nominations (2000–2025)</h1>
  </header>
  <main>
    <aside id="yearList"></aside>
    <section>
      <div id="results">Choose a year to load nominations.</div>
      <div id="status" class="status"></div>
    </section>
  </main>
  <script>
    const YEAR_START = 2000;
    const YEAR_END = 2025;
    const yearListEl = document.getElementById("yearList");
    const contentEl = document.getElementById("results");
    const statusEl = document.getElementById("status");

    const CACHE_KEY = "oscars_nominations_cache_v2";
    let cache = JSON.parse(localStorage.getItem(CACHE_KEY) || "{}");

    function saveCache() {
      localStorage.setItem(CACHE_KEY, JSON.stringify(cache));
    }

    // Build year buttons
    for (let y = YEAR_END; y >= YEAR_START; y--) {
      const btn = document.createElement("div");
      btn.className = "year-item";
      btn.textContent = y;
      btn.dataset.year = y;
      btn.addEventListener("click", () => selectYear(y, btn));
      yearListEl.appendChild(btn);
    }
async function selectYear(year, el) {
      document.querySelectorAll(".year-item")
        .forEach(x => x.classList.remove("active"));
      if (el) el.classList.add("active");

      statusEl.textContent = `Loading ${year}...`;
      contentEl.innerHTML = "";

      // If cached → show instantly
      if (cache[year]) {
        statusEl.textContent = `Loaded from cache — ${year}`;
        renderData(cache[year]);
        return;
      }

      try {
        const num = year - 1928;  // ceremony number approx.
        const page = encodeURIComponent(`${num}th_Academy_Awards`);

        const url = `https://en.wikipedia.org/w/api.php?action=parse&page=${page}&prop=text&formatversion=2&origin=*`;

        const res = await fetch(url);
        if (!res.ok) throw new Error("Network error");

        const json = await res.json();
        if (json.error) throw new Error(json.error.info || "API error");

        const html = json.parse.text;
        const data = extractWinnersAndNominees(html);

        data._meta = {
          year,
          page: `${num}th Academy Awards`,
          fetchedAt: new Date().toISOString()
        };

        cache[year] = data;
        saveCache();

        statusEl.textContent = `Loaded — ${year}`;
        renderData(data);

      } catch (err) {
        statusEl.textContent = `Error loading ${year}: ${err.message}`;
        contentEl.innerHTML = `<pre>${err.stack || err.message}</pre>`;
      }
    }

    // NEW IMPROVED PARSER
    function extractWinnersAndNominees(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      // Try multiple headline patterns because Wikipedia is inconsistent
      const patterns = [
        /Winners\s*and\s*nominees/i,
        /Winners/i,
        /Nominees/i,
        /Nominations/i,
        /Awards/i,
      ];

      // Gather text headers (h2, h3, h4)
      const headers = Array.from(
        doc.querySelectorAll("h2, h3, h4")
      ).map(h => ({
        el: h,
        text: (h.textContent || "").trim()
      }));

      // Find first matching header
      let target = null;
      for (const p of patterns) {
        target = headers.find(h => p.test(h.text));
        if (target) break;
      }

      if (!target) {
        return { error: "Winners and nominees section not found" };
      }

      // Section root (after first heading)
      let node = target.el.nextElementSibling;
      const categories = [];

      while (node && !/^h[2]$/i.test(node.tagName)) {
        if (/^h[3]$/i.test(node.tagName)) {
          const categoryName = node.textContent.trim();
          const category = { category: categoryName, nominees: [] };

          let li = node.nextElementSibling;
          while (li && li.tagName.toLowerCase() !== "h3") {
            if (li.tagName.toLowerCase() === "ul") {
              Array.from(li.querySelectorAll("li")).forEach(x => {
                const text = x.textContent.trim();
                const isWinner = /winner/i.test(text) ||
                                 x.style.fontWeight === "bold";
                category.nominees.push({ text, winner: isWinner });
              });
            }
            li = li.nextElementSibling;
          }

          categories.push(category);
          node = li;
          continue;
        }

        node = node.nextElementSibling;
      }

      return { categories };
    }

    function escapeHtml(s) {
      return s
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function renderData(data) {
      if (data.error) {
        contentEl.innerHTML = `<div class="small">${data.error}</div>`;
        return;
      }

      const q = searchInput.value.trim().toLowerCase();
      contentEl.innerHTML = "";

      data.categories.forEach(cat => {
        if (q) {
          const searchSpace = (cat.category + " " +
            cat.nominees.map(n => n.text).join(" ")).toLowerCase();
          if (!searchSpace.includes(q)) return;
        }

        const wrap = document.createElement("div");
        wrap.className = "category";

        wrap.innerHTML = `
          <div class="cat-title">
            <strong>${escapeHtml(cat.category)}</strong>
            <span class="small">${cat.nominees.length} nominees</span>
          </div>
        `;

        const list = document.createElement("div");
        list.className = "nominees";

        cat.nominees.forEach(n => {
          const el = document.createElement("div");
          el.className = "nominee" + (n.winner ? " winner" : "");
          el.textContent = n.text;
          list.appendChild(el);
        });

        wrap.appendChild(list);
        contentEl.appendChild(wrap);
      });
    }

    // Load the latest year automatically
    document.querySelector(".year-item").click();
  </script>

</body>
</html>

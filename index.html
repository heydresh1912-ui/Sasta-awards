<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Oscars — Nominations (2000–2025)</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--muted:#9aa4b2;--accent:#f59e0b}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial; margin:0;background:linear-gradient(180deg,#071029 0%, #07121a 100%);color:#e6eef6}
    header{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;gap:16px;align-items:center}
    h1{margin:0;font-size:20px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    select,input{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit}
    main{padding:18px;display:grid;grid-template-columns:260px 1fr;gap:18px}
    aside{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px}
    .year-list{display:flex;flex-direction:column;gap:6px;max-height:70vh;overflow:auto;padding-right:6px}
    .year-item{padding:8px;border-radius:8px;cursor:pointer}
    .year-item.active{background:linear-gradient(90deg,#142534,#0b2536);box-shadow:0 4px 14px rgba(0,0,0,0.6)}
    .content{background:rgba(255,255,255,0.01);padding:16px;border-radius:12px;min-height:70vh;overflow:auto}
    .category{margin-bottom:18px;padding-bottom:10px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .cat-title{display:flex;justify-content:space-between;align-items:center}
    .nominees{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .nominee{padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .winner{background:linear-gradient(90deg,rgba(245,158,11,0.12),rgba(245,158,11,0.03));border:1px solid rgba(245,158,11,0.12)}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
    .small{font-size:13px;color:var(--muted)}
    button{background:var(--accent);color:#04201b;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .busy{opacity:0.6}
    pre{white-space:pre-wrap}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Oscars — Nominations (2000–2025)</h1>
      <div class="small">Data fetched live from Wikipedia (MediaWiki API) — ceremony pages 2000→2025.</div>
    </div>
    <div class="controls">
      <input id="search" placeholder="Filter categories or nominees..." />
      <button id="exportJson">Export JSON</button>
    </div>
  </header>

  <main>
    <aside>
      <div class="small" style="margin-bottom:8px">Select a ceremony year</div>
      <div class="year-list" id="yearList"></div>
      <div style="margin-top:12px" class="small">Tip: data is cached in your browser for faster browsing.</div>
    </aside>

    <section class="content" id="content">
      <div id="status" class="small">Choose a year to load nominations.</div>
      <div id="results"></div>
    </section>
  </main>

  <footer>
    Built with ❤️ — fetches Wikipedia ceremony pages for each year and extracts the "Winners and nominees" section.
  </footer>
<script>
    // small rebuild marker (safe to leave)
    // rebuild

    // Utility: compute ordinal (72 -> "72nd", 73 -> "73rd", etc.)
    function ordinal(n){
      const s=["th","st","nd","rd"], v=n%100;
      return n + (s[(v-20)%10]||s[v]||s[0]);
    }

    function ceremonyNumberFromYear(year){ return year - 1928; }

    const YEAR_START = 2000, YEAR_END = 2025;
    const yearListEl = document.getElementById('yearList');
    const contentEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const searchInput = document.getElementById('search');

    // Build UI year buttons
    for(let y=YEAR_END;y>=YEAR_START;y--){
      const btn = document.createElement('div');
      btn.className='year-item';
      btn.textContent = y;
      btn.dataset.year = y;
      btn.addEventListener('click', ()=>selectYear(y, btn));
      yearListEl.appendChild(btn);
    }

    // Cache structure in localStorage
    const CACHE_KEY = 'oscars_nominations_cache_v1';
    let cache = JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');

    function saveCache(){ localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); }

    async function selectYear(year, el){
      document.querySelectorAll('.year-item').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      statusEl.textContent = `Loading nominations for ${year}...`;
      contentEl.innerHTML='';

      if(cache[year]){
        statusEl.textContent = `Loaded from cache — ${year}`;
        renderData(cache[year]);
        return;
      }

      try{
        const num = ceremonyNumberFromYear(year);
        const page = encodeURIComponent(ordinal(num) + '_Academy_Awards');
        const url = `https://en.wikipedia.org/w/api.php?action=parse&page=${page}&prop=text&format=json&origin=*`;
        const res = await fetch(url);
        if(!res.ok) throw new Error('Network error');
        const json = await res.json();
        if(json.error) throw new Error(json.error.info || 'API error');
        const html = json.parse.text['*'];
        const data = extractWinnersAndNominees(html);
        data._meta = {year, page:`${ordinal(num)} Academy Awards`, fetchedAt: new Date().toISOString() };
        cache[year] = data;
        saveCache();
        statusEl.textContent = `Loaded — ${year}`;
        renderData(data);
      }catch(err){
        statusEl.textContent = `Error loading ${year}: ${err.message}`;
        contentEl.innerHTML = `<pre>${err.stack||err.message}</pre>`;
      }
    }
        // Robust parser placed inside the script block
    function extractWinnersAndNominees(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html,'text/html');

      const headlinePatterns = [
        /\bWinners\s*and\s*nominees\b/i,
        /\bWinners\b/i,
        /\bNominees\b/i,
        /\bNominations\b/i,
        /\bAwards\b/i
      ];

      const headlines = Array.from(doc.querySelectorAll('span.mw-headline, h2, h3, h4')).map(h=>{
        return {el: h, text: (h.textContent||'').trim()};
      });

      let targetEntry = null;
      for(const p of headlinePatterns){
        targetEntry = headlines.find(h => p.test(h.text));
        if(targetEntry) break;
      }
      if(!targetEntry) targetEntry = headlines.find(h => /\b(nominee|winner|selection)\b/i.test(h.text));
      if(!targetEntry){
        const bigSection = doc.querySelector('h2, h3, h4');
        if(bigSection) targetEntry = {el: bigSection, text: bigSection.textContent.trim()};
      }
      if(!targetEntry) return {error:'Winners and nominees section not found on page'};

      let sectionRoot = targetEntry.el.closest('h2, h3, h4') || targetEntry.el;
      const result = {categories:[]};
      let node = sectionRoot.nextElementSibling;

      while(node && node.tagName && node.tagName.toLowerCase()!=='h2'){
        const tag = node.tagName.toLowerCase();

        if(tag==='h3' || tag==='h4'){
          const catName = node.textContent.trim();
          const cat = {category:catName, nominees:[]};
          let n2 = node.nextElementSibling;
          while(n2 && !/^h[1-4]$/.test(n2.tagName.toLowerCase())){
            const t2 = n2.tagName.toLowerCase();
            if(t2==='ul'){
              Array.from(n2.querySelectorAll('li')).forEach(li=>{
                const text = li.textContent.trim();
                const isWinner = /\(Winner\)|\bWinner\b|\bwon\b/i.test(li.innerHTML) || li.querySelector('.winner')!=null;
                if(text) cat.nominees.push({text, winner:isWinner});
              });
            } else if(t2==='table'){
              Array.from(n2.querySelectorAll('tr')).forEach(tr=>{
                const cols = Array.from(tr.querySelectorAll('td,th')).map(c=>c.textContent.trim()).filter(Boolean);
                if(cols.length){
                  const text = cols.join(' — ');
                  const isWinner = /winner/i.test(tr.textContent) || tr.querySelector('.winner')!=null;
                  cat.nominees.push({text, winner:isWinner});
                }
              });
            } else if(t2==='p'){
              const lines = n2.textContent.split('\n').map(s=>s.trim()).filter(Boolean);
              lines.forEach(L=>{
                if(L.length>20){
                  const isWinner = /\(Winner\)|\bWinner\b/i.test(L);
                  cat.nominees.push({text:L, winner:isWinner});
                }
              });
            }
            n2 = n2.nextElementSibling;
          }
          result.categories.push(cat);
          node = n2;
          continue;
        }

        if(tag==='ul'){
          const cat = {category: sectionRoot.textContent.trim() || 'Nominees', nominees:[]};
          Array.from(node.querySelectorAll('li')).forEach(li=>{
            const text = li.textContent.trim();
            const isWinner = /\(Winner\)|\bWinner\b|\bwon\b/i.test(li.innerHTML) || li.querySelector('.winner')!=null;
            if(text) cat.nominees.push({text, winner:isWinner});
          });
          result.categories.push(cat);
          node = node.nextElementSibling;
          continue;
        }

        if(tag==='table'){
          const cat = {category: sectionRoot.textContent.trim() || 'Nominees', nominees:[]};
          Array.from(node.querySelectorAll('tr')).forEach(tr=>{
            const cols = Array.from(tr.querySelectorAll('td,th')).map(c=>c.textContent.trim()).filter(Boolean);
            if(cols.length){
              const text = cols.join(' — ');
              const isWinner = /winner/i.test(tr.textContent) || tr.querySelector('.winner')!=null;
              cat.nominees.push({text, winner:isWinner});
            }
          });
          result.categories.push(cat);
          node = node.nextElementSibling;
          continue;
        }

        node = node.nextElementSibling;
      }

      result.categories = result.categories.filter(c => c.nominees && c.nominees.length);
      if(!result.categories.length) return {error:'No nominees found in the detected section'};
      return result;
    }

    function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    function renderData(data){
      if(data.error){ contentEl.innerHTML = `<div class="small">${escapeHtml(data.error)}</div>`; return; }
      const q = searchInput.value.trim().toLowerCase();
      contentEl.innerHTML = '';
      data.categories.forEach(cat=>{
        if(q){
          const hay = (cat.category + ' ' + cat.nominees.map(n=>n.text).join(' ')).toLowerCase();
          if(!hay.includes(q)) return;
        }
        const wrap = document.createElement('div'); wrap.className='category';
        const title = document.createElement('div'); title.className='cat-title';
        title.innerHTML = `<strong>${escapeHtml(cat.category)}</strong><span class="small">${cat.nominees.length} nominees</span>`;
        wrap.appendChild(title);
        const list = document.createElement('div'); list.className='nominees';
        cat.nominees.forEach(n=>{
          const el = document.createElement('div'); el.className='nominee'+(n.winner?' winner':'');
          el.innerHTML = escapeHtml(n.text);
          list.appendChild(el);
        });
        wrap.appendChild(list);
        contentEl.appendChild(wrap);
      });
      if(contentEl.children.length===0) contentEl.innerHTML = '<div class="small">No categories matched your search.</div>';
    }

    // Search listener
    searchInput.addEventListener('input', ()=>{
      if(!Object.keys(cache).length){ statusEl.textContent='No data loaded yet.'; return; }
      const active = document.querySelector('.year-item.active');
      if(active){ const year = active.dataset.year; renderData(cache[year]); }
    });

    // Export JSON
    document.getElementById('exportJson').addEventListener('click', ()=>{
      const active = document.querySelector('.year-item.active');
      if(!active) return alert('Select a year first');
      const year = active.dataset.year;
      const data = cache[year];
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `oscars_${year}_nominations.json`; document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // Auto-select latest year by default (if year-items exist)
    const firstYear = document.querySelector('.year-item');
    if(firstYear) firstYear.click();
  </script>
</body>
</html>

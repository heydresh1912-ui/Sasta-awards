<script>
    function ordinal(n){
      const s=["th","st","nd","rd"], v=n%100;
      return n + (s[(v-20)%10]||s[v]||s[0]);
    }

    function ceremonyNumberFromYear(year){ return year - 1928; }

    const YEAR_START = 2000, YEAR_END = 2025;
    const yearListEl = document.getElementById('yearList');
    const contentEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const searchInput = document.getElementById('search');

    for(let y=YEAR_END;y>=YEAR_START;y--){
      const btn = document.createElement('div');
      btn.className='year-item';
      btn.textContent = y;
      btn.dataset.year = y;
      btn.addEventListener('click', ()=>selectYear(y, btn));
      yearListEl.appendChild(btn);
    }

    const CACHE_KEY = 'oscars_nominations_cache_v1';
    let cache = JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');

    function saveCache(){ localStorage.setItem(CACHE_KEY, JSON.stringify(cache)); }

    async function selectYear(year, el){
      document.querySelectorAll('.year-item').forEach(x=>x.classList.remove('active'));
      el.classList.add('active');
      statusEl.textContent = `Loading nominations for ${year}...`;
      contentEl.innerHTML='';

      if(cache[year]){
        statusEl.textContent = `Loaded from cache — ${year}`;
        renderData(cache[year]);
        return;
      }

      try{
        const num = ceremonyNumberFromYear(year);
        const page = encodeURIComponent(ordinal(num) + '_Academy_Awards');
        const url = `https://en.wikipedia.org/w/api.php?action=parse&page=${page}&prop=text&format=json&origin=*`;

        const res = await fetch(url);
        if(!res.ok) throw new Error('Network error');

        const json = await res.json();
        if(json.error) throw new Error(json.error.info || 'API error');

        const html = json.parse.text['*'];
        const data = extractWinnersAndNominees(html);

        data._meta = {
          year,
          page:`${ordinal(num)} Academy Awards`,
          fetchedAt: new Date().toISOString()
        };

        cache[year] = data;
        saveCache();
        statusEl.textContent = `Loaded — ${year}`;
        renderData(data);

      } catch(err){
        statusEl.textContent = `Error loading ${year}: ${err.message}`;
        contentEl.innerHTML = `<pre>${err.stack||err.message}</pre>`;
      }
    }

    function extractWinnersAndNominees(html){
      const parser = new DOMParser();
      const doc = parser.parseFromString(html,'text/html');
      const headlines = Array.from(doc.querySelectorAll('span.mw-headline'));
      const target = headlines.find(h => /Winners\s*and\s*nominees/i.test(h.textContent));

      if(!target)
        return {error:'Winners and nominees section not found on page'};

      let sectionRoot = target.closest('h2') || target.closest('h3');
      const result = {categories:[]};
      let node = sectionRoot.nextElementSibling;

      while(node && node.tagName.toLowerCase()!=='h2'){
        if(node.tagName.toLowerCase()==='h3'){
          const catName = node.textContent.trim();
          const cat = {category:catName, nominees:[]};

          let n2 = node.nextElementSibling;
          while(n2 && !/^h[1-4]$/.test(n2.tagName.toLowerCase())){
            if(n2.tagName.toLowerCase()==='ul'){
              Array.from(n2.querySelectorAll('li')).forEach(li=>{
                const text = li.textContent.trim();
                const isWinner = /\bWinner\b|\bwon\b/i.test(text);
                cat.nominees.push({text, winner:isWinner});
              });
            }
            n2 = n2.nextElementSibling;
          }

          result.categories.push(cat);
          node = n2;
          continue;
        }
        node = node.nextElementSibling;
      }

      return result;
    }

    function escapeHtml(s){
      return s.replace(/&/g,'&amp;')
              .replace(/</g,'&lt;')
              .replace(/>/g,'&gt;');
    }

    function renderData(data){
      if(data.error){
        contentEl.innerHTML = `<div class="small">${data.error}</div>`;
        return;
      }

      const q = searchInput.value.trim().toLowerCase();
      contentEl.innerHTML = '';

      data.categories.forEach(cat=>{
        if(q){
          const searchSpace = (cat.category + ' ' + cat.nominees.map(n=>n.text).join(' ')).toLowerCase();
          if(!searchSpace.includes(q)) return;
        }

        const wrap = document.createElement('div');
        wrap.className='category';

        wrap.innerHTML = `
          <div class="cat-title">
            <strong>${escapeHtml(cat.category)}</strong>
            <span class="small">${cat.nominees.length} nominees</span>
          </div>
        `;

        const list = document.createElement('div');
        list.className='nominees';

        cat.nominees.forEach(n=>{
          const el = document.createElement('div');
          el.className='nominee' + (n.winner ? ' winner' : '');
          el.innerHTML = escapeHtml(n.text);
          list.appendChild(el);
        });

        wrap.appendChild(list);
        contentEl.appendChild(wrap);
      });
    }

    document.querySelector('.year-item').click();
  </script>

</body>
</html>
